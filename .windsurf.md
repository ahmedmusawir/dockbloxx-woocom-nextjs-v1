# DockBloxx WooCommerce Next.js - Windsurf Context

## Project Overview
**Name:** DockBloxx WooCommerce Next.js v1  
**Type:** E-commerce frontend (Next.js 15) + WordPress/WooCommerce backend  
**Hosting:** Vercel (frontend), WordPress staging/production (backend)  
**Primary Goal:** High-performance, SEO-optimized dock accessories e-commerce platform with advanced attribution tracking and CRM integration

---

## Tech Stack

### Frontend
- **Framework:** Next.js 15 (App Router, Turbopack)
- **Language:** TypeScript (strict mode, 2-space indentation)
- **Styling:** TailwindCSS + shadcn/ui components
- **State Management:** Zustand (checkout, cart)
- **Payment:** Stripe
- **Icons:** Lucide React

### Backend
- **CMS:** WordPress + WooCommerce
- **API:** WooCommerce REST API + WordPress GraphQL (WPGraphQL)
- **Custom Plugins:** Cyberize Attribution (GHL integration)
- **Attribution Script:** Coach's custom JavaScript (sessionStorage-based)

### Integrations
- **CRM:** GoHighLevel (GHL) - Inbound Webhook for Opportunities
- **Analytics:** GTM (Google Tag Manager)
- **SEO:** Yoast SEO (WordPress) ‚Üí Next.js metadata

---

## Project Structure

```
src/
‚îú‚îÄ‚îÄ app/                    # Next.js 15 App Router
‚îÇ   ‚îú‚îÄ‚îÄ (public)/          # Public routes (products, blog, checkout)
‚îÇ   ‚îú‚îÄ‚îÄ api/               # API routes (place-order, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx         # Root layout with tracking scripts
‚îú‚îÄ‚îÄ components/            # React components
‚îÇ   ‚îú‚îÄ‚îÄ checkout/         # Checkout flow components
‚îÇ   ‚îú‚îÄ‚îÄ cart/             # Cart components
‚îÇ   ‚îú‚îÄ‚îÄ global/           # Navbar, Footer
‚îÇ   ‚îî‚îÄ‚îÄ common/           # Reusable UI components
‚îú‚îÄ‚îÄ lib/                   # Utilities
‚îÇ   ‚îú‚îÄ‚îÄ attribution.ts    # Attribution data reader
‚îÇ   ‚îú‚îÄ‚îÄ couponUtils.ts    # Coupon validation logic
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts          # General utilities
‚îú‚îÄ‚îÄ services/              # API service layers
‚îÇ   ‚îú‚îÄ‚îÄ checkoutServices.ts
‚îÇ   ‚îú‚îÄ‚îÄ blogServices.ts
‚îÇ   ‚îî‚îÄ‚îÄ trackingSeoServices.ts
‚îú‚îÄ‚îÄ store/                 # Zustand state stores
‚îÇ   ‚îî‚îÄ‚îÄ useCheckoutStore.ts
‚îú‚îÄ‚îÄ types/                 # TypeScript interfaces
‚îú‚îÄ‚îÄ constants/             # API endpoints, configs
‚îî‚îÄ‚îÄ rest-api/             # WooCommerce REST API wrappers

docs/
‚îú‚îÄ‚îÄ ghl-attribution/      # GHL integration documentation
‚îî‚îÄ‚îÄ wp-plugins/           # WordPress plugin code
    ‚îú‚îÄ‚îÄ cyberize-attribution.php
    ‚îî‚îÄ‚îÄ attribution-script.md

public/                    # Static assets
tests/                     # Jest tests
```

---

## Key Conventions

### Code Style
- **TypeScript:** Strict mode, explicit types, no `any`
- **Indentation:** 2 spaces (no tabs)
- **Components:** PascalCase (e.g., `ProductCard.tsx`)
- **Hooks:** `useXxx` prefix (e.g., `useCheckoutTracking.ts`)
- **Services:** Noun + verb (e.g., `orderServices.ts`)
- **Exports:** Named exports preferred (avoid default unless single export)

### File Naming
- Components: `PascalCase.tsx`
- Utilities: `camelCase.ts`
- Services: `camelCase.ts`
- Types: `camelCase.ts`
- Constants: `SCREAMING_SNAKE_CASE` or `camelCase.ts`

### Session Documentation
- **Location:** Root directory (e.g., `GHL_ATTRIBUTION_SESSION.md`)
- **Purpose:** Track major integration work, decisions, test results
- **Format:** Markdown with clear sections (Objective, Completed, Test Results, Next Steps)
- **Update:** After each major milestone or testing phase
 - **Daily Log Convention:** At the start of every working day, create a new file in the repo root named `session-YYYY-MM-DD.md` (e.g., `session-2026-01-30.md`). Throughout the day, append notes for:
   - changes made (with file paths),
   - lessons learned/decisions,
   - test URLs and outcomes (what showed in WP Orders and GHL),
   - next steps/todos.
   If work continues the next day, create a new dated file and keep going. This guarantees fast ramp-up after any interruption.

---

## Environment Variables

### Required (Production)
```env
NEXT_PUBLIC_APP_URL=https://dockbloxx.com
NEXT_PUBLIC_BACKEND_URL=https://dockbloxx.mystagingwebsite.com
WOOCOM_CONSUMER_KEY=ck_xxx
WOOCOM_CONSUMER_SECRET=cs_xxx
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_xxx
STRIPE_SECRET_KEY=sk_xxx
```

### Development
```env
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_BACKEND_URL=https://dockbloxx.mystagingwebsite.com
# Same keys as production for staging backend
```

---

## Development Workflow

### Commands
```bash
npm run dev          # Start dev server (Turbopack)
npm run build        # Production build
npm start            # Run built app
npm test             # Run Jest tests
npm run test:watch   # Watch mode
npm run lint         # ESLint check
```

### Build Notes
- **Static Generation:** Blog pages and product pages are statically generated at build time
- **Revalidation:** Tracking scripts cached for 1 hour (`revalidate: 3600`)
- **Build Time:** 5-10 minutes (fetches all products from WooCommerce)

### Testing Strategy
- **Unit Tests:** Jest + Testing Library
- **Location:** `tests/` mirroring source structure
- **Naming:** `*.test.ts(x)`
- **Mocking:** Mock WooCommerce/WordPress/Stripe network calls
- **Coverage:** Focus on critical paths (checkout, attribution, coupon validation)

---

## Attribution & GHL Integration

### Data Flow
```
User visits with UTMs/coupon
    ‚Üì
Coach's script ‚Üí sessionStorage
    ‚Üì
User completes checkout
    ‚Üì
Frontend reads sessionStorage ‚Üí attribution object
    ‚Üì
POST to /api/place-order
    ‚Üì
WooCommerce order meta (_coach_ghl_* prefix)
    ‚Üì
Order status ‚Üí "processing"
    ‚Üì
WordPress plugin triggered
    ‚Üì
POST to GHL Inbound Webhook
    ‚Üì
GHL creates Contact + Opportunity
```

### Key Files
- **Frontend:** `src/lib/attribution.ts`, `src/components/checkout/right-pane/ApplyCoupon.tsx`
- **API:** `src/app/api/place-order/route.ts`
- **WordPress:** `docs/wp-plugins/cyberize-attribution.php`
- **Script:** `docs/wp-plugins/attribution-script.md` (deployed to WordPress ACF)

### Attribution Fields
- UTMs: `utm_source`, `utm_medium`, `utm_campaign`, `utm_content`, `utm_keyword`
- Click IDs: `gclid`, `fbclid`
- Other: `landing_page`, `coupon`, `attribution_captured_at`

### GHL Webhook
- **URL:** Stored in WordPress settings (WooCommerce ‚Üí Cyberize Attribution)
- **Payload:** camelCase JSON (firstName, lastName, etc.)
- **Idempotency:** `_cyberize_ghl_sent` flag prevents duplicates
- **Debugging:** WordPress Orders page shows sync status

---

## Common Tasks

### Adding a New Attribution Field
1. Update Coach's script (`attribution-script.md`) - add to KEYS array
2. Update `src/lib/attribution.ts` - add to interface and `getAttribution()`
3. Update WordPress plugin - ensure field is sent to GHL
4. Update GHL workflow - map field to Contact/Opportunity
5. Test end-to-end with test URL

### Deploying Changes
1. **Frontend:** Push to GitHub ‚Üí Vercel auto-deploys
2. **WordPress Plugin:** SFTP to `wp-content/plugins/cyberize-attribution/`
3. **Attribution Script:** Update in WordPress ACF field `coach_attribution_scripts_footer`

### Debugging Attribution Issues
1. Check browser console for sessionStorage values
2. Check WooCommerce order meta for `_coach_ghl_*` fields
3. Check WordPress Orders page debug panel
4. Check GHL workflow execution logs
5. Verify webhook URL in WordPress settings

---

## Important Notes

### Do NOT
- Commit `.env.local` or secrets
- Edit files outside `/docs` when in review-only mode
- Use `any` type in TypeScript
- Add comments unless explicitly requested
- Delete or weaken tests without direction
- Hardcode API keys or sensitive data

### DO
- Keep changes minimal and focused
- Follow existing code patterns
- Write tests for critical functionality
- Use absolute imports (`@/...`)
- Verify build passes before PR
- Update session docs after major changes
- Test locally before deploying

---

## Current Status (as of Jan 30, 2026)

### ‚úÖ Completed
- GHL Attribution Integration (full end-to-end)
- Coupon auto-fill from QR codes
- WordPress plugin with debug panel
- Build fix (revalidate caching)

### üöß Pending
- Deploy to staging
- Edge case testing (direct traffic, partial UTMs)
- Production deployment
- Consider removing debug panel after stabilization

### üìù Active Session Doc
- **File:** `GHL_ATTRIBUTION_SESSION.md` (root)
- **Last Updated:** Jan 30, 2026 @ 9:58 AM UTC+8

---

## Contact & Resources
- **Developer:** Moose (user)
- **Coach:** Product owner, provides attribution script and requirements
- **GHL Workflow:** Moose - Dockblox to GHL
- **WordPress Staging:** https://dockbloxx.mystagingwebsite.com
- **Frontend Staging:** TBD (Vercel)

---

*This file should be updated as the project evolves. Keep it concise and actionable.*
